\chapter{Cell Balancing}
\label{cha:balancing}
As discussed in the introduction, the problem of battery balancing is fundamental to maximize the net battery capacity. Figure \ref{fig:imbalance} shows the voltage status of E-Agle TRT's old battery pack after a year of usage.

\begin{figure}[h]
    \centering
    \input{pictures/chimera_imbalance.tex}
    \caption{Unbalanced cells}
    \label{fig:imbalance}
\end{figure}

As can be seen in the chart, The difference between the highest-voltage cell ($V_{max} = V_{70} = 3.712V$) and the lowest-voltage cell ($V_{min} = V_{73} = 3.554V$) is $V_{delta}=V_{max}-V{min}=0.158V$. Assuming an equal discharge of every cell, with a cut-off voltage of 3.000V, the lowest average voltage obtainable is $V_{low}=V_{cutoff}+(V_{avg}-V_{min})=3.066V$. Similarly, considering an equal charge with a cut-off voltage of 4.200V, the average voltage could only reach $V_{high}=V_{cutoff}+(V_{max}-V_{avg})=4.109V$.\\
Assuming the voltage vs discharge capacity curve of a Lithium-Ion cell \cite{vtc5}, the expected loss is close to 6\%, or 3\% for each case.
With the use of a cell balancing algorithm, $V_{delta}$ can be reduced to less than 10mV, rendering losses negligible.

\section{Strategy}
The balancing hardware on the BMS is passive: cells can only be discharged by connecting resistors in parallel with them. Thus, energy is converted into waste heat. To avoid unwanted battery discharge, cell balancing is only done when the battery is connected to a charger.\\
Cell balancing is divided into temporal cycles of 10 to 60 seconds. At the beginning of a cycle an algorithm selects the cells to discharge and instructs the hardware which starts to discharge the cells. After the cycle's time is elapsed the hardware stops the discharge, then the cycle repeats.\\
A limitation in the balancing hardware doesn't permit two adjacent cells to be discharged simultaneously. For this reason a custom algorithm has been devised to select which cells need and can be discharged.

\section{Implementation}
Per funzionare, l'algoritmo implementato prende in input il vettore delle tensioni `voltages[]` e il valore `threshold` e restituisce un vettore di booleani `indexes[]` che indica quali celle vanno scaricate.
\begin{listing}[h]
    \begin{minted}{c}
uint8_t balancing_compute(uint16_t voltages[], uint16_t threshold, uint16_t indexes[]);
\end{minted}
    \caption{Balancing function signature}
    \label{listing:bal_signature}
\end{listing}

The algorithm is made of the selection and the evaluation part: the former compute the imbalance between cells while the latter selects the optimal combination of cells that can be discharged simultaneously.

\subsection{Imbalance}

The imbalance computation algorithm assigns to each cell an integer value that is equals to the difference between the cell and the lowest voltage cell
Let $I[i]$ be the imbalance of cell $i$.
\[
    I[i] = voltages[i] - (min\_voltage + threshold)
\]

The implementation below cuts the imbalance to values greater than zero, as cells with negative imbalance don't need to be discharged.

\begin{algorithm}[H]
    \DontPrintSemicolon
    \NoCaptionOfAlgo
    \caption[imbalance]{\INTARRAY\ \textsf{imbalance}(\INTARRAY\ $voltages$, \INTEGER\ $n$, \INTEGER\ $threshold$)}\label{algorithm:imbalance}


    $I = \INTEGER[0 \ldots n-1]$\;
    $min\_voltage=\textsf{min}(voltages)$\;
    \For{$i=0 \to\ n$}{
    $I[i] = \textsf{max}(0, voltages[i] - (min\_voltage + threshold))$\;
    }
    \Return{I}
\end{algorithm}

\section{Exclusion}
Because of a hardware limitation on the Cellboards, neighboring cells cannot be discharged simultaneously. This limitation poses the interesting challenge of finding the combination of compatible cells that need to be discharged. The problem is similar to a canonical optimization problem that can be solved efficiently with Dynamic Programming.

%Given a vector of imbalances $I$ of size $n$ select a subset of cells that maximizes total imbalance while being not-adjacent and not having null imbalance.\\
%
%Let $Cells(i)$ be a subset of indexes that maximizes the imbalance from the first $i$ cells. Given this definition, $Cells(n)$ is the optimal solution to the problem.
%
%\subsection{Base cases}
%\[
%    Cells(0)=
%    \begin{cases}
%        \{ \emptyset \} & n=0\ or\ (n=1\ and\ I[n-1]=0) \\
%    \end{cases}
%    If $n=1\ and\ I[n-1]>0$ then $Cells(0)=\{ i-1 \}$ \\
%\]
%
%\subsection{Recursive step}
%For cell $i$ two options are available:
%\begin{itemize}
%    \item if $i$ is selected, then $Cells(i)=Cells(i-2) \cup \begin{cases}\{i-1\} & I[i-1]>0\\ \{\emptyset \}& otherwise\end{cases}$
%    \item if $i$ is skipped, then $Cells(i)=Cells(i-1)$
%\end{itemize}
%The choice to select $i$ or not is made by considering the resulting set and picking the one with higher imbalance:
%\[ Cells(i) = \begin{cases}
%        Cells(i-1)                                              & I(i-1) = 0 \\
%        \mathit{highest}(Cells(i-1),\ Cells(i-2) \cup \{i - 1\} & I(i-1) > 0 \\
%    \end{cases}\]
%
%The complete solution can be expressed with the following recursive equation:
%\[
%    Cells(i) = \begin{cases}
%        \emptyset                                                & i=0                  \\
%        \{i-1\}                                                  & i=1                  \\
%        Cells(i-1)                                               & i \ge 2,\ I(i-1) = 0 \\
%        \mathit{highest}(Cells(i-1),\ Cells(i-2) \cup \{i - 1\}) & i \ge 2,\ I(i-1) > 0 \\
%    \end{cases}
%\]
%
\subsection{Concept}

Instead of finding the output set directly, the maximum sum of all imbalances is computed first by using an helper array, and then solution is recovered from it. This approach is more efficient and easier to implement than working with sets right away, especially on a microcontroller.

\subsubsection{Computing the maximum}
Let $C[i]$ be the maximum total imbalance that can be obtained with the first $i$ cells.\\
$C[n]$ is the solution of the problem.

\paragraph{Step}

For each cell $i$, two options can be considered:
\begin{enumerate}
    \item If cell $i$ is discarded, cell $i-1$ can be selected:
          \[
              C[i]=C[i-1]
          \]

    \item If cell $i$ is selected, cell $i-1$ has to be discarded, but $i-2$ can be selected:
          \[
              C[i]=I[i-1]+C[i-2]
          \]
\end{enumerate}

To maximize the total imbalance, the highest of the two possibilities is chosen:
\[
    C[i]=\max(C[i-1],\ I[i-1] + C[i-2])
\]



\paragraph{Base cases}
The base cases consider the occasion in which the input set is empty or when only one cell is present
\begin{itemize}
    \item $C[0]=0$
    \item $C[1]=I[0]$
\end{itemize}

\[
    C[i] = \begin{cases}
        0                                      & i=0      \\
        I[0]                                   & i=1      \\
        \mathit{\max}(C[i-1], C[i-2] + I[i-1]) & i \geq 2
    \end{cases}
\]
\begin{algorithm}
    \DontPrintSemicolon
    \NoCaptionOfAlgo
    \caption[exclude]{\INTEGER\ \textsf{exclude} (\INTARRAY\ $D$, \INTEGER\ $n$)}\label{algorithm:exclude}
    $\INTARRAY\ DP = \INTEGER[0 \ldots n]$\;

    $DP[0] = 0$\;
    $DP[1] = D[0]$\;

    \For{$i=2 \to\ n + 1$}{
        $DP[i] = \max(DP[i-1],\ DP[i-2] + D[i-1])$\;
    }

    \Return{$DP[n]$}\;
\end{algorithm}

\subsubsection{Reconstructing the solution}
The above equation describes a correct albeit partial solution to the problem. The final result can be constructed by analyzing the vector $C$ in a top-down fashion.

\begin{algorithm}[H]
    \DontPrintSemicolon
    \NoCaptionOfAlgo
    \caption[solution]{\SET\ \textsf{solution} (\INTARRAY\ $D$, \INTEGER\ $i$)}\label{algorithm:solution}
    \uIf{i == 0}{
        \Return{ $\{\emptyset \}$ }\;
    }
    \uElseIf{i == 1}{
        \uIf(\tcp*[h]{we only want to add cells with positive imbalance}){$D[1] > 0$}{
            \Return{ $\{0\}$ }\;
        }
        \Else{
            \Return{ $\{\emptyset \}$ }\;
        }
    }
    \uElseIf{$D[i] == D[i-1]$}{
        \Return{$\textsf{solution}(D, i-1)$}\;
    }
    \Else{
        \Return{$\textsf{solution}(D, i-2) \cup \{i-1\}$}\;
    }
\end{algorithm}

The complete algorithm is as follows:

\begin{algorithm}
    \DontPrintSemicolon
    \NoCaptionOfAlgo
    \caption[balancing]{\SET\ \textsf{balance} (\INTARRAY\ $voltages$, \INTEGER\ $n$, \INTEGER\ $threshold$)}\label{algorithm:balancing}

    \INTARRAY\ $I = \textsf{imbalance}(voltages,\ threshold)$\;

    \If{$I={\{\emptyset \}}$}{
    \Return{$\{\emptyset \}$}\;
    }

    \textsf{exclude}(I, )

    \Return{$\textsf{solution}(I, n)$}
\end{algorithm}
